<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>物流ハイブリッド計測</title>
    <style>
        * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; touch-action: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; }
        #video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        
        .ui { position: absolute; top: 0; left: 0; width: 100%; z-index: 10; pointer-events: none; }
        .header { background: rgba(0,0,0,0.85); color: white; padding: 20px; text-align: center; pointer-events: auto; }
        
        /* 状態表示ラベル */
        .mode-badge { font-size: 14px; padding: 5px 15px; border-radius: 20px; font-weight: bold; transition: 0.3s; }
        .mode-none { background: #555; }
        .mode-auto { background: #ff9800; } /* 概算（オレンジ） */
        .mode-high { background: #007bff; box-shadow: 0 0 10px #007bff; } /* 高精度（青） */

        .result-panel { margin-top: 15px; font-size: 36px; color: #00ff00; font-weight: bold; }
        .sub-info { font-size: 11px; color: #aaa; margin-top: 5px; }
    </style>
</head>
<body>

<video id="video" autoplay playsinline></video>
<canvas id="overlay"></canvas>

<div class="ui">
    <div class="header">
        <span id="modeLabel" class="mode-badge mode-none">準備中...</span>
        <div id="result" class="result-panel">-- × -- cm</div>
        <div id="debugMsg" class="sub-info">カメラを起動しています</div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    
    let pixelPerCm = 0;
    let devicePitch = 0; // 傾き
    let currentMode = "none"; // none, auto(概算), high(高精度)

    async function init() {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment', width: { ideal: 1280 } } 
        });
        video.srcObject = stream;
        
        // 角度センサーの許可（iOS対策）
        if (window.DeviceOrientationEvent && DeviceOrientationEvent.requestPermission) {
            window.addEventListener('click', () => {
                DeviceOrientationEvent.requestPermission();
            }, {once: true});
        }
        window.addEventListener('deviceorientation', (e) => { devicePitch = e.beta; });

        video.onloadedmetadata = () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            requestAnimationFrame(mainLoop);
        };
    }

    function mainLoop() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 1. メジャー検出を試みる
            const detectedGap = scanForRuler();
            
            if (detectedGap > 0) {
                // 【高精度モード】
                pixelPerCm = detectedGap;
                currentMode = "high";
                updateUI("高精度モード (メジャー検知中)", "mode-high");
            } else {
                // 【概算モード】（角度から推測）
                // 持ち手の高さを120cm、角度45度付近での標準px比率を計算
                const angleRad = (devicePitch || 45) * (Math.PI / 180);
                pixelPerCm = 15 * Math.sin(angleRad); // 簡易的な概算ロジック
                currentMode = "auto";
                updateUI("概算モード (角度から推測)", "mode-auto");
            }
        }
        requestAnimationFrame(mainLoop);
    }

    function scanForRuler() {
        // 中央付近をサンプリング
        const sampleY = canvas.height * 0.5;
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width; tempCanvas.height = 1;
        const tCtx = tempCanvas.getContext('2d');
        tCtx.drawImage(video, 0, sampleY * (video.videoHeight/canvas.height), video.videoWidth, 1, 0, 0, canvas.width, 1);
        const data = tCtx.getImageData(0, 0, canvas.width, 1).data;

        let darkPoints = [];
        for (let i = 0; i < data.length; i += 4) {
            if ((data[i] + data[i+1] + data[i+2]) / 3 < 90) darkPoints.push(i / 4);
        }

        let gaps = [];
        for (let j = 1; j < darkPoints.length; j++) {
            const d = darkPoints[j] - darkPoints[j-1];
            if (d > 15 && d < 80) gaps.push(d);
        }

        if (gaps.length >= 4) {
            // 検知箇所を青く強調
            ctx.strokeStyle = "#007bff"; ctx.lineWidth = 2;
            ctx.strokeRect(0, sampleY-10, canvas.width, 20);
            return gaps.reduce((a, b) => a + b) / gaps.length;
        }
        return 0;
    }

    function updateUI(msg, className) {
        const label = document.getElementById('modeLabel');
        label.innerText = msg;
        label.className = "mode-badge " + className;
        document.getElementById('debugMsg').innerText = `角度: ${Math.round(devicePitch)}° / 基準px: ${Math.round(pixelPerCm)}`;
    }

    window.addEventListener('touchstart', () => {
        if (pixelPerCm < 1) return;
        const productPx = 350; // 仮の検知幅
        const w = Math.round(productPx / pixelPerCm);
        const d = Math.round(w * 0.8);
        document.getElementById('result').innerText = `${w} × ${d} cm`;
    });

    window.addEventListener('load', init);
</script>
</body>
</html>
