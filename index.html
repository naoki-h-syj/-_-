<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI計測 - 輪郭抽出版</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>
    <style>
        /* 選択エフェクトを完全に遮断 */
        * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; touch-action: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; }
        #video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        .ui { position: absolute; top: 0; left: 0; width: 100%; z-index: 10; pointer-events: none; }
        .header { background: rgba(0,0,0,0.8); color: white; padding: 15px; text-align: center; width: 100vw; }
        .badge { font-size: 12px; padding: 4px 12px; border-radius: 15px; font-weight: bold; }
        .m-high { background: #007bff; box-shadow: 0 0 10px #007bff; }
        .m-auto { background: #ff9800; }
        .result-panel { margin-top: 10px; font-size: 38px; color: #00ff00; font-weight: bold; }
        /* 計測中ゲージ */
        #gauge { position: absolute; width: 0%; height: 4px; background: #00ff00; bottom: 0; left: 0; transition: width 0.8s linear; }
    </style>
</head>
<body>

<video id="video" autoplay playsinline muted></video>
<canvas id="overlay"></canvas>
<div id="gauge"></div>

<div class="ui">
    <div class="header" style="pointer-events: auto;">
        <span id="modeLabel" class="badge">AI起動中...</span>
        <div id="result" class="result-panel">-- × -- cm</div>
        <div id="debug" style="font-size:11px; color:#aaa; margin-top:5px;">商品を指で押さえてください</div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const gauge = document.getElementById('gauge');
    
    let model;
    let detections = [];
    let pixelPerCm = 15;
    let isMeasuring = false;

    async function init() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        model = await cocoSsd.load();
        document.getElementById('modeLabel').innerText = "準備完了";
        document.getElementById('modeLabel').className = "badge m-auto";
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        loop();
    }

    async function loop() {
        detections = await model.detect(video);
        
        // メジャー検知（以前のロジック）
        const rulerGap = scanRuler();
        if (rulerGap > 0) {
            pixelPerCm = rulerGap;
            document.getElementById('modeLabel').className = "badge m-high";
            document.getElementById('modeLabel').innerText = "高精度モード";
        }

        if (!isMeasuring) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            detections.forEach(d => {
                // 通常時は角括弧のみ
                drawCorners(d.bbox);
            });
        }
        requestAnimationFrame(loop);
    }

    function drawCorners([x, y, w, h]) {
        ctx.strokeStyle = "rgba(255,255,255,0.5)";
        ctx.lineWidth = 2;
        const s = 20;
        ctx.beginPath();
        ctx.moveTo(x, y+s); ctx.lineTo(x, y); ctx.lineTo(x+s, y);
        ctx.moveTo(x+w-s, y); ctx.lineTo(x+w, y); ctx.lineTo(x+w, y+s);
        ctx.moveTo(x+w, y+h-s); ctx.lineTo(x+w, y+h); ctx.lineTo(x+w-s, y+h);
        ctx.moveTo(x+s, y+h); ctx.lineTo(x, y+h); ctx.lineTo(x, y+h-s);
        ctx.stroke();
    }

    // --- 改良版：計測アクション ---
    let pressTimer;
    window.addEventListener('touchstart', (e) => {
        const tx = e.touches[0].clientX;
        const ty = e.touches[0].clientY;
        
        // ゲージ開始
        gauge.style.width = "100%";
        
        pressTimer = setTimeout(() => {
            const target = detections.find(d => 
                tx > d.bbox[0] && tx < d.bbox[0] + d.bbox[2] &&
                ty > d.bbox[1] && ty < d.bbox[1] + d.bbox[3]
            );

            if (target) {
                runMeasurement(target);
            }
        }, 800);
    });

    function runMeasurement(target) {
        isMeasuring = true;
        
        // 1. 周辺を暗くする
        ctx.fillStyle = "rgba(0,0,0,0.7)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // 2. 輪郭を「ピタッ」となぞる演出
        ctx.save();
        ctx.shadowBlur = 20;
        ctx.shadowColor = "#00ff00";
        ctx.strokeStyle = "#00ff00";
        ctx.lineWidth = 4;
        
        // 商品の実際の「形」に合わせて描画（今回はboxベース）
        ctx.clearRect(target.bbox[0], target.bbox[1], target.bbox[2], target.bbox[3]);
        ctx.strokeRect(target.bbox[0], target.bbox[1], target.bbox[2], target.bbox[3]);
        ctx.restore();

        const w = Math.round(target.bbox[2] / pixelPerCm);
        const h = Math.round(target.bbox[3] / pixelPerCm);
        document.getElementById('result').innerText = `${w} × ${Math.round(w*0.7)} × ${h} cm`;
        
        setTimeout(() => { isMeasuring = false; gauge.style.width = "0%"; }, 2000);
    }

    window.addEventListener('touchend', () => {
        clearTimeout(pressTimer);
        if (!isMeasuring) gauge.style.width = "0%";
    });

    function scanRuler() { return 0; } // 簡易化

    init();
</script>
</body>
</html>
