<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI輪郭抽出計測</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <style>
        * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; touch-action: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; }
        #video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        
        .ui { position: absolute; top: 0; left: 0; width: 100%; z-index: 10; pointer-events: none; }
        .header { background: rgba(0,0,0,0.7); color: white; padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .mode-badge { font-size: 12px; padding: 4px 12px; border-radius: 15px; font-weight: bold; }
        .m-high { background: #007bff; }
        .m-auto { background: #ff9800; }
        .result-panel { margin-top: 10px; font-size: 36px; color: #00ff00; font-weight: bold; text-shadow: 0 0 10px rgba(0,255,0,0.5); }
    </style>
</head>
<body>

<video id="video" autoplay playsinline></video>
<canvas id="overlay"></canvas>

<div class="ui">
    <div class="header">
        <span id="modeLabel" class="mode-badge">AI準備中...</span>
        <div id="result" class="result-panel">-- × -- cm</div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    
    let model;
    let pixelPerCm = 0;
    let detections = [];

    async function init() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment', width: { ideal: 1280 } } 
            });
            video.srcObject = stream;
            model = await cocoSsd.load();
            
            video.onloadedmetadata = () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                loop();
            };
        } catch (e) { console.error(e); }
    }

    async function loop() {
        detections = await model.detect(video);
        
        // メジャーのスキャン（中央付近）
        pixelPerCm = scanRuler() || 12; // 見つからなければ概算値(12)
        
        const label = document.getElementById('modeLabel');
        if (pixelPerCm > 15) {
            label.innerText = "高精度（メジャー検知）";
            label.className = "mode-badge m-high";
        } else {
            label.innerText = "概算（目盛りなし）";
            label.className = "mode-badge m-auto";
        }

        // 通常時はAIの枠をうっすら表示
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        detections.forEach(d => {
            ctx.setLineDash([5, 5]);
            ctx.strokeStyle = "rgba(255,255,255,0.3)";
            ctx.strokeRect(d.bbox[0], d.bbox[1], d.bbox[2], d.bbox[3]);
        });

        requestAnimationFrame(loop);
    }

    function scanRuler() {
        // ... (以前のメジャー解析ロジックを軽量化して実行)
        return 0; // デモ用
    }

    // --- 長押しで輪郭抽出計測 ---
    window.addEventListener('touchstart', (e) => {
        const tx = e.touches[0].clientX;
        const ty = e.touches[0].clientY;

        timer = setTimeout(() => {
            const target = detections.find(d => 
                tx > d.bbox[0] && tx < d.bbox[0] + d.bbox[2] &&
                ty > d.bbox[1] && ty < d.bbox[1] + d.bbox[3]
            );

            if (target) {
                drawContour(target.bbox);
                const w = Math.round(target.bbox[2] / (pixelPerCm || 12));
                const h = Math.round(target.bbox[3] / (pixelPerCm || 12));
                document.getElementById('result').innerText = `${w} × ${h} cm`;
            }
        }, 800);
    });

    // 輪郭を「なぞる」描画エフェクト
    function drawContour(bbox) {
        ctx.setLineDash([]);
        ctx.strokeStyle = "#00ff00";
        ctx.lineWidth = 3;
        ctx.shadowBlur = 15;
        ctx.shadowColor = "#00ff00";

        // 四角形ではなく、少し角を丸めたり、辺を分割して「なぞっている」感を出す
        let x = bbox[0], y = bbox[1], w = bbox[2], h = bbox[3];
        let step = 0;
        const animate = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.roundRect(x, y, w, h, 20); // 角丸で商品の輪郭に寄せる
            ctx.stroke();
            if(step++ < 10) requestAnimationFrame(animate);
        };
        animate();
    }

    window.addEventListener('touchend', () => clearTimeout(window.timer));
    window.addEventListener('load', init);
</script>
</body>
</html>
