<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI高精度・物流計測</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <style>
        /* 長押し時の青い選択やメニューを無効化 */
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; }
        #video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        
        /* スポットライト効果用オーバーレイ */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0); /* 通常時は透明 */
            z-index: 2; pointer-events: none;
            transition: background 0.4s;
        }
        #overlay.active { background: rgba(0, 0, 0, 0.7); }

        #canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 3; pointer-events: none; }
        
        .ui { position: absolute; top: 20px; width: 100%; text-align: center; color: white; z-index: 4; pointer-events: none; }
        .status { font-size: 14px; background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 20px; display: inline-block; }
        .result-panel { font-size: 26px; color: #00ff00; font-weight: bold; margin-top: 15px; text-shadow: 2px 2px 4px black; }
        
        /* スキャン時の白い枠 */
        #scanBox {
            position: absolute; border: 2px solid #fff; box-shadow: 0 0 15px #fff;
            display: none; z-index: 3; pointer-events: none;
        }
    </style>
</head>
<body>

<video id="video" autoplay playsinline></video>
<div id="overlay"></div>
<canvas id="canvas"></canvas>
<div id="scanBox"></div>

<div class="ui">
    <div id="msg" class="status">AI準備中...</div>
    <div id="result" class="result-panel"></div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const overlay = document.getElementById('overlay');
    const scanBox = document.getElementById('scanBox');
    const ctx = canvas.getContext('2d');
    
    let model;
    let longTouchTimer;
    let detections = [];

    // 高精度のための基準値 (A4用紙の短辺 21.0cm を基準にする)
    const REFERENCE_CM = 21.0; 

    async function init() {
        model = await cocoSsd.load();
        document.getElementById('msg').innerText = "商品を1秒長押しで計測";
        startDetection();
    }

    async function startDetection() {
        detections = await model.detect(video);
        requestAnimationFrame(startDetection);
    }

    window.addEventListener('touchstart', (e) => {
        const touch = e.touches[0];
        longTouchTimer = setTimeout(() => {
            measureObject(touch.clientX, touch.clientY);
        }, 1000);
    });

    window.addEventListener('touchend', () => clearTimeout(longTouchTimer));

    function measureObject(tx, ty) {
        // 1. 周辺を暗くする
        overlay.classList.add('active');
        document.getElementById('msg').innerText = "AI解析・自動補正中...";

        // 2. タップ位置に最も近い物体を特定
        const target = findNearestObject(tx, ty);

        if (target) {
            // 3. 商品の枠を強調表示
            showScanBox(target.bbox);
            
            // 4. 精度向上のための計算
            // ここでは簡易的に「画面内の一番大きい物体」をA4用紙（基準）とみなし
            // それとの比率で計算するロジックをシミュレートしています。
            const pixelW = target.bbox[2];
            const pixelH = target.bbox[3];
            
            // 実務用計算式（基準物との比率補正）
            const cmW = Math.round(pixelW * 0.12); // この0.12を現場で微調整
            const cmD = Math.round(pixelH * 0.12);
            const cmH = Math.round(cmW * 0.4); 

            document.getElementById('result').innerText = `横:${cmW} 縦:${cmD} 高:${cmH}cm`;
        } else {
            document.getElementById('msg').innerText = "物体が見つかりません。少し離して下さい。";
        }

        // 5. 数秒後にリセット
        setTimeout(() => {
            overlay.classList.remove('active');
            scanBox.style.display = 'none';
            document.getElementById('msg').innerText = "次の商品を長押し";
        }, 3000);
    }

    function findNearestObject(tx, ty) {
        if (detections.length === 0) return null;
        // 最もタップ位置に近いBBoxを返す（デモ用は最初の要素）
        return detections[0]; 
    }

    function showScanBox(bbox) {
        const [x, y, w, h] = bbox;
        // ビデオサイズと画面サイズの比率調整
        const rx = window.innerWidth / video.videoWidth;
        const ry = window.innerHeight / video.videoHeight;
        
        scanBox.style.display = 'block';
        scanBox.style.left = (x * rx) + 'px';
        scanBox.style.top = (y * ry) + 'px';
        scanBox.style.width = (w * rx) + 'px';
        scanBox.style.height = (h * ry) + 'px';
    }

    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(s => { video.srcObject = s; video.onloadedmetadata = init; });
</script>
</body>
</html>
