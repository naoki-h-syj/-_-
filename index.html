<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>全自動目盛り解析計測</title>
    <style>
        * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; }
        #video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; opacity: 0.5; }
        
        .ui { position: absolute; top: 0; left: 0; width: 100%; z-index: 10; pointer-events: none; }
        .header { background: rgba(0,0,0,0.8); color: white; padding: 15px; text-align: center; pointer-events: auto; }
        .status-light { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #ff0000; margin-right: 5px; }
        .status-ready { background: #00ff00; box-shadow: 0 0 10px #00ff00; }
        .result-panel { margin-top: 10px; font-size: 32px; font-weight: bold; color: #00ff00; }
    </style>
</head>
<body>

<video id="video" autoplay playsinline></video>
<canvas id="overlay"></canvas>

<div class="ui">
    <div class="header">
        <div id="statusWrap"><span id="indicator" class="status-light"></span> <span id="statusTxt">背景のメジャーを探しています...</span></div>
        <div id="result" class="result-panel">-- × -- × -- cm</div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    let pixelPerCm = 0;

    async function init() {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } 
        });
        video.srcObject = stream;
        requestAnimationFrame(autoAnalyze);
    }

    function autoAnalyze() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = 160; // 解析負荷を下げるため縮小
            canvas.height = 90;
            
            // 画面の複数箇所（上・中・下）をサンプリング
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const samples = [
                ctx.getImageData(40, 45, 80, 1).data, // 中央
                ctx.getImageData(40, 20, 80, 1).data, // 上部
                ctx.getImageData(40, 70, 80, 1).data  // 下部
            ];

            let foundGaps = [];

            samples.forEach(data => {
                let darkPoints = [];
                for (let i = 0; i < data.length; i += 4) {
                    const bright = (data[i] + data[i+1] + data[i+2]) / 3;
                    if (bright < 90) darkPoints.push(i / 4);
                }

                if (darkPoints.length > 4) {
                    for (let j = 1; j < darkPoints.length; j++) {
                        const d = darkPoints[j] - darkPoints[j-1];
                        if (d > 8 && d < 40) foundGaps.push(d);
                    }
                }
            });

            if (foundGaps.length > 10) {
                // 最頻値を採用して安定させる
                const avg = foundGaps.reduce((a, b) => a + b) / foundGaps.length;
                const multiplier = window.innerWidth / 80; // 縮小した分を戻す
                pixelPerCm = avg * multiplier;

                document.getElementById('indicator').classList.add('status-ready');
                document.getElementById('statusTxt').innerText = "自動校正完了 (長押しで計測)";
            }
        }
        requestAnimationFrame(autoAnalyze);
    }

    // 商品計測（指を置いた位置の物体をシミュレーション）
    window.addEventListener('touchstart', (e) => {
        if (pixelPerCm === 0) return;
        
        // 周辺を暗くする視覚効果
        document.body.style.opacity = "0.7";

        timer = setTimeout(() => {
            // ここでは簡易的に画面上の300pxを商品幅として計算
            // 本来はここに「商品の輪郭抽出」を組み合わせます
            const basePixelW = 400; 
            const cmW = Math.round(basePixelW / pixelPerCm);
            const cmD = Math.round(cmW * 0.8);
            const cmH = Math.round(cmW * 0.5);

            document.getElementById('result').innerText = `${cmW} × ${cmD} × ${cmH} cm`;
            document.body.style.opacity = "1";
        }, 800);
    });

    window.addEventListener('touchend', () => {
        clearTimeout(window.timer);
        document.body.style.opacity = "1";
    });

    window.addEventListener('load', init);
</script>
</body>
</html>
