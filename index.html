<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>メジャー目盛り解析計測</title>
    <style>
        * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; }
        #video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        
        .ui { position: absolute; top: 0; left: 0; width: 100%; z-index: 10; pointer-events: none; }
        .header { background: rgba(0,0,0,0.8); color: white; padding: 15px; text-align: center; pointer-events: auto; }
        .guide { font-weight: bold; font-size: 14px; color: #00ff00; }
        
        /* 中央の読み取りエリア */
        .scan-window {
            position: absolute; top: 50%; left: 50%; width: 200px; height: 40px;
            border: 2px solid #ff0000; transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(255,0,0,0.5); z-index: 5;
        }
        .result-panel { margin-top: 10px; font-size: 28px; font-weight: bold; color: #fff; }
    </style>
</head>
<body>

<video id="video" autoplay playsinline></video>
<canvas id="overlay"></canvas>
<div class="scan-window"></div>

<div class="ui">
    <div class="header">
        <div class="guide">赤枠に背面のメジャーを水平に合わせてください</div>
        <div id="pxInfo" style="font-size:10px; color:#aaa;">目盛りを探しています...</div>
        <div id="result" class="result-panel">-- × -- × -- cm</div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    let pixelPerCm = 0;

    async function init() {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment', width: 1280, height: 720 } 
        });
        video.srcObject = stream;
        requestAnimationFrame(analyzeScale);
    }

    // 目盛りのピクセル間隔を解析するメインロジック
    function analyzeScale() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // ビデオの中央付近をキャプチャ
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const midY = Math.floor(canvas.height / 2);
            const startX = Math.floor(canvas.width / 2 - 100);
            const imageData = ctx.getImageData(startX, midY, 200, 1).data;

            let darkPoints = [];
            // 輝度解析で目盛り（黒い線）を探す
            for (let i = 0; i < imageData.length; i += 4) {
                const brightness = (imageData[i] + imageData[i+1] + imageData[i+2]) / 3;
                if (brightness < 80) { // 黒い線の判定しきい値
                    darkPoints.push(i / 4);
                }
            }

            // 隣り合う黒い線の間隔（ピクセル）を計算
            if (darkPoints.length > 5) {
                let gaps = [];
                for (let j = 1; j < darkPoints.length; j++) {
                    const d = darkPoints[j] - darkPoints[j-1];
                    if (d > 5 && d < 50) gaps.push(d); // 極端なノイズを除外
                }
                if (gaps.length > 0) {
                    const avgGap = gaps.reduce((a, b) => a + b) / gaps.length;
                    pixelPerCm = avgGap; // 1cmごとの太い目盛りを想定
                    document.getElementById('pxInfo').innerText = `解析成功: 1cm = ${Math.round(pixelPerCm)}px`;
                }
            }
        }
        requestAnimationFrame(analyzeScale);
    }

    // 商品計測（画面長押し）
    let timer;
    window.addEventListener('touchstart', (e) => {
        timer = setTimeout(() => {
            if (pixelPerCm < 5) {
                alert("メジャーを正しく認識できていません。");
                return;
            }
            // 簡易的に画面中央の仮想商品のサイズを計算
            // 本来はここに前回のAI枠取得を組み合わせます
            const mockPixelW = 300; 
            const mockPixelH = 200;

            const w = Math.round(mockPixelW / pixelPerCm);
            const h = Math.round(mockPixelH / pixelPerCm);
            const d = Math.round(w * 0.7);

            document.getElementById('result').innerText = `${w} × ${d} × ${h} cm`;
        }, 1000);
    });

    window.addEventListener('touchend', () => clearTimeout(timer));
    window.addEventListener('load', init);
</script>
</body>
</html>
