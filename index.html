<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>物流AR計測（距離計算版）</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        .status-panel {
            position: absolute; top: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.85); color: white;
            padding: 15px 0; z-index: 1000; text-align: center;
        }
        .guide-msg { font-size: 18px; font-weight: bold; margin-bottom: 8px; }
        .measure-val { display: flex; justify-content: space-around; font-size: 14px; }
        .color-w { border-bottom: 4px solid #0000ff; padding-bottom: 2px; }
        .color-d { border-bottom: 4px solid #ff0000; padding-bottom: 2px; }
        .color-h { border-bottom: 4px solid #00ff00; padding-bottom: 2px; }
        .btn-reset {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.9); color: black; border: none;
            padding: 12px 30px; border-radius: 25px; z-index: 1000; font-weight: bold;
        }
        .reticle {
            position: absolute; top: 50%; left: 50%; width: 24px; height: 24px;
            border: 2px solid #00ff00; border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 1000;
        }
        .reticle::after { content: ''; position: absolute; top: 50%; left: 50%; width: 2px; height: 2px; background: #00ff00; transform: translate(-50%, -50%); }
    </style>
</head>
<body onclick="handleTap()">

<div class="status-panel">
    <div id="guideMsg" class="guide-msg">
        <span style="color:#4dabf7;">【横(幅)】</span> の両端をタップ
    </div>
    <div class="measure-val">
        <span id="label-w" class="color-w">横: --cm</span>
        <span id="label-d" class="color-d">縦: --cm</span>
        <span id="label-h" class="color-h">高: --cm</span>
    </div>
    <div id="resultBox" style="margin-top:10px; font-size:22px; color:#00ff00; font-weight:bold; min-height:28px;"></div>
</div>

<div class="reticle"></div>
<button class="btn-reset" onclick="location.reload()">やり直す</button>

<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false">
    <a-entity camera look-controls="enabled: false"></a-entity>
    <a-entity id="linesGroup"></a-entity>
    <a-sphere id="tempPoint" visible="false" radius="0.01"></a-sphere>
</a-scene>

<script>
    let step = 0; 
    let isMeasuring = false;
    let startQuat = null; // 1点目のカメラの向き（回転）
    let dims = { w: 0, d: 0, h: 0 };
    
    const colors = ["#0000ff", "#ff0000", "#00ff00"];
    const labels = ["横(幅)", "縦(奥行)", "高さ"];

    function handleTap() {
        if (step > 2) return;

        const camera = document.querySelector('[camera]').object3D;
        
        if (!isMeasuring) {
            // 1点目：現在のカメラの回転情報を記録
            startQuat = camera.quaternion.clone();
            isMeasuring = true;
            document.getElementById('guideMsg').innerHTML = `<span style="color:${colors[step]};">【${labels[step]}】</span> の反対側をタップ`;
        } else {
            // 2点目：1点目との「角度の差」を計算
            const endQuat = camera.quaternion.clone();
            const angle = startQuat.angleTo(endQuat); // ラジアン単位の角度差
            
            // 距離推定ロジック（物体まで約50cm離れていると仮定した簡易計算）
            // 角度差（ラジアン） × 物体までの距離 = 弧の長さ（辺の長さ）
            const estimatedDist = Math.round(angle * 65); // 65は調整係数
            
            saveDimension(Math.max(5, estimatedDist));
            
            isMeasuring = false;
            step++;
            updateUI();
        }
    }

    function saveDimension(val) {
        if (step === 0) dims.w = val;
        if (step === 1) dims.d = val;
        if (step === 2) dims.h = val;
    }

    function updateUI() {
        document.getElementById('label-w').innerText = `横: ${dims.w || '--'}cm`;
        document.getElementById('label-d').innerText = `縦: ${dims.d || '--'}cm`;
        document.getElementById('label-h').innerText = `高: ${dims.h || '--'}cm`;

        if (step <= 2) {
            document.getElementById('guideMsg').innerHTML = `<span style="color:${colors[step]};">【${labels[step]}】</span> の両端をタップ`;
        } else {
            calculateFinal();
        }
    }

    function calculateFinal() {
        const boxList = [
            { name: "サイズ100", w: 45, d: 35, h: 20 },
            { name: "サイズ120", w: 55, d: 40, h: 25 },
            { name: "サイズ140", w: 65, d: 50, h: 25 },
            { name: "サイズ160", w: 75, d: 55, h: 30 }
        ];
        // 3辺をソートして比較
        const req = [dims.w + 3, dims.d + 3, dims.h + 3].sort((a,b) => a-b);
        let found = "適合する箱がありません";
        
        for (let box of boxList) {
            const bSize = [box.w, box.d, box.h].sort((a,b) => a-b);
            if (req[0] <= bSize[0] && req[1] <= bSize[1] && req[2] <= bSize[2]) {
                found = `推奨：${box.name}`;
                break;
            }
        }
        document.getElementById('guideMsg').innerText = "計測完了！";
        document.getElementById('resultBox').innerText = found;
    }
</script>
</body>
</html>
