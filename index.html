<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI長押し計測</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; }
        #video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        #overlayCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        .ui { position: absolute; top: 20px; width: 100%; text-align: center; color: white; z-index: 3; pointer-events: none; }
        .status { font-size: 18px; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 5px; display: inline-block; }
        .scan-effect { 
            position: absolute; border: 2px solid #00ff00; background: rgba(0,255,0,0.1); 
            display: none; pointer-events: none; z-index: 2; 
        }
    </style>
</head>
<body>

<video id="video" autoplay playsinline></video>
<canvas id="overlayCanvas"></canvas>
<div id="scanFrame" class="scan-effect"></div>

<div class="ui">
    <div id="msg" class="status">商品を1秒間長押しして計測</div>
    <div id="result" style="margin-top:10px; font-size:24px; color:#00ff00; font-weight:bold;"></div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('overlayCanvas');
    const scanFrame = document.getElementById('scanFrame');
    const ctx = canvas.getContext('2d');
    
    let longTouchTimer;
    let isMeasuring = false;

    // カメラ起動
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => { video.srcObject = stream; });

    // 長押し検知の実装
    window.addEventListener('touchstart', (e) => {
        if (isMeasuring) return;
        const touch = e.touches[0];
        
        longTouchTimer = setTimeout(() => {
            startAimeasure(touch.clientX, touch.clientY);
        }, 1000); // 1秒で長押し判定
    });

    window.addEventListener('touchend', () => {
        clearTimeout(longTouchTimer);
    });

    function startAimeasure(x, y) {
        isMeasuring = true;
        document.getElementById('msg').innerText = "物体を解析中...";
        
        // 視覚的なスキャンエフェクト
        scanFrame.style.display = 'block';
        scanFrame.style.left = (x - 50) + 'px';
        scanFrame.style.top = (y - 50) + 'px';
        scanFrame.style.width = '100px';
        scanFrame.style.height = '100px';

        // 疑似的な物体検知アニメーション（本来はここでAIモデルを呼び出す）
        let size = 100;
        const interval = setInterval(() => {
            size += 10;
            scanFrame.style.left = (x - size/2) + 'px';
            scanFrame.style.top = (y - size/2) + 'px';
            scanFrame.style.width = size + 'px';
            scanFrame.style.height = size + 'px';
            
            if (size > 300) {
                clearInterval(interval);
                finishMeasure(size);
            }
        }, 30);
    }

    function finishMeasure(pixelSize) {
        // ピクセルサイズから実寸への変換（将来的にAIで距離を推定）
        const mockDist = Math.round(pixelSize * 0.3); 
        const w = mockDist, d = Math.round(mockDist*0.8), h = Math.round(mockDist*0.5);
        
        document.getElementById('msg').innerText = "計測完了";
        document.getElementById('result').innerText = `横:${w} 縦:${d} 高:${h}cm`;
        
        setTimeout(() => {
            scanFrame.style.display = 'none';
            isMeasuring = false;
            document.getElementById('msg').innerText = "次の商品を長押し";
        }, 3000);
    }
</script>
</body>
</html>
