<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>物流AR計測（ライン表示版）</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        .status-panel {
            position: absolute; top: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.8); color: white;
            padding: 15px 0; z-index: 1000; text-align: center;
        }
        .guide-msg { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        .guide-msg span { padding: 2px 8px; border-radius: 4px; }
        .measure-val { display: flex; justify-content: space-around; font-size: 14px; margin-top: 10px; }
        
        /* 色分けのラベル */
        .color-w { border-bottom: 4px solid #0000ff; } /* 横：青 */
        .color-d { border-bottom: 4px solid #ff0000; } /* 縦(奥行)：赤 */
        .color-h { border-bottom: 4px solid #00ff00; } /* 高さ：緑 */

        .btn-reset {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #666; color: white; border: none;
            padding: 12px 30px; border-radius: 25px; z-index: 1000; font-weight: bold;
        }
        .reticle {
            position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
            border: 2px solid white; border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 1000;
        }
    </style>
</head>
<body onclick="handleTap()">

<div class="status-panel">
    <div id="guideMsg" class="guide-msg">
        <span style="background:#0000ff;">横(幅)</span> の両端をタップしてください
    </div>
    <div class="measure-val">
        <span id="label-w" class="color-w">横: --cm</span>
        <span id="label-d" class="color-d">縦: --cm</span>
        <span id="label-h" class="color-h">高: --cm</span>
    </div>
    <div id="resultBox" style="margin-top:10px; font-size:20px; color:#00ff00; font-weight:bold;"></div>
</div>

<div class="reticle"></div>
<button class="btn-reset" onclick="resetMeasure()">やり直す</button>

<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false">
    <a-entity camera>
        <a-entity id="activeLine" line="color: white; opacity: 0.8"></a-entity>
    </a-entity>
    
    <a-entity id="linesGroup"></a-entity>
    <a-sphere id="tempPoint" visible="false" radius="0.015"></a-sphere>
</a-scene>

<script>
    let step = 0; // 0:横(W), 1:縦(D), 2:高さ(H)
    let isMeasuring = false;
    let startPos = null;
    let dims = { w: 0, d: 0, h: 0 };
    
    const colors = ["#0000ff", "#ff0000", "#00ff00"]; // 青、赤、緑
    const labels = ["横(幅)", "縦(奥行)", "高さ"];

    function handleTap() {
        if (step > 2) return;

        const camera = document.querySelector('[camera]');
        const currentPos = camera.object3D.position.clone();
        // カメラの向いている方向に少し進んだ位置を擬似点とする
        const direction = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.object3D.quaternion);
        const hitPoint = currentPos.add(direction.multiplyScalar(0.5));

        if (!isMeasuring) {
            // 1点目
            startPos = hitPoint.clone();
            showPoint(startPos, colors[step]);
            isMeasuring = true;
        } else {
            // 2点目
            const endPos = hitPoint.clone();
            const distance = Math.round(startPos.distanceTo(endPos) * 100); // センチ換算の擬似計算
            
            finalizeLine(startPos, endPos, colors[step]);
            saveDimension(distance);
            
            isMeasuring = false;
            startPos = null;
            step++;
            updateUI();
        }
    }

    function showPoint(pos, color) {
        const p = document.getElementById('tempPoint');
        p.setAttribute('position', pos);
        p.setAttribute('material', 'color', color);
        p.setAttribute('visible', 'true');
    }

    function finalizeLine(start, end, color) {
        const lineEntity = document.createElement('a-entity');
        lineEntity.setAttribute('line', {
            start: start,
            end: end,
            color: color,
            width: 5
        });
        document.getElementById('linesGroup').appendChild(lineEntity);
        document.getElementById('tempPoint').setAttribute('visible', 'false');
    }

    function saveDimension(val) {
        const baseVal = Math.max(15, val); // 最小値を15cmとするデモ調整
        if (step === 0) dims.w = baseVal;
        if (step === 1) dims.d = baseVal;
        if (step === 2) dims.h = baseVal;
    }

    function updateUI() {
        document.getElementById('label-w').innerText = `横: ${dims.w || '--'}cm`;
        document.getElementById('label-d').innerText = `縦: ${dims.d || '--'}cm`;
        document.getElementById('label-h').innerText = `高: ${dims.h || '--'}cm`;

        if (step <= 2) {
            document.getElementById('guideMsg').innerHTML = `<span style="background:${colors[step]};">${labels[step]}</span> の両端をタップしてください`;
        } else {
            calculateFinal();
        }
    }

    function calculateFinal() {
        const boxList = [
            { name: "サイズ100", w: 45, d: 35, h: 20 },
            { name: "サイズ120", w: 55, d: 40, h: 25 },
            { name: "サイズ140", w: 65, d: 50, h: 25 },
            { name: "サイズ160", w: 75, d: 55, h: 30 }
        ];
        const req = [dims.w + 3, dims.d + 3, dims.h + 3].sort((a,b) => a-b);
        let found = "適合なし";
        for (let box of boxList) {
            const bSize = [box.w, box.d, box.h].sort((a,b) => a-b);
            if (req[0] <= bSize[0] && req[1] <= bSize[1] && req[2] <= bSize[2]) {
                found = `推奨：${box.name}`;
                break;
            }
        }
        document.getElementById('guideMsg').innerText = "計測完了！";
        document.getElementById('resultBox').innerText = found;
    }

    function resetMeasure() {
        location.reload();
    }
</script>
</body>
</html>
